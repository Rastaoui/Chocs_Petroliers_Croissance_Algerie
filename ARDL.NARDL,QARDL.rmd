```{r}
library(tidyverse)
library(skimr)
library(ARDL)
library(tseries)
library(ggplot2)
library(reshape2)
library(lmtest)
```

```{r}
```


```{r}
data = read.csv("C:/Users/ahmed/OneDrive/Desktop/PYTHR.csv" , sep = ";") %>% drop_na()
```

```{r}
skim(data)
```

```{r}
data$croiss_PIB...= as.numeric(data$croiss_PIB...)
```

```{r}
glimpse(data)
```

```{r}
library(ggplot2)

ggplot(data, aes(x = Annee, y = Prix.du.Petrole)) +
  geom_line(color = "steelblue") +
  labs(title = "Prix rÃ©el du pÃ©trole (Brent, USD constants)", x = "AnnÃ©e", y = "Prix du pÃ©trole")

```


```{r}
ggplot(data, aes(x = Annee, y = croiss_PIB...)) +
  geom_line(color = "darkgreen") +
  labs(title = "Croissance rÃ©elle du PIB en AlgÃ©rie", x = "AnnÃ©e", y = "Croissance (%)")

```

```{}
 corrÃ©lation sans lâ€™annÃ©e
```

```{r}
summary(data)
cor(data[, -1])  

```

```{r}

data_long <- melt(data, id.vars = "Annee")
ggplot(data_long, aes(x = Annee, y = value, color = variable)) + geom_line(size = 1) +
facet_wrap(~ variable, scales = "free_y") +theme_minimal() +labs(title = "Ã‰volution temporelle des variables Ã©conomiques en AlgÃ©rie")

```

```{r}
# H0:non stationnarite
adf.test(data$croiss_PIB..., alternative = "stationary") #la sÃ©rie nâ€™est pas stationnaire.
adf.test(data$inflation, alternative = "stationary") #la sÃ©rie nâ€™est pas stationnaire.
adf.test(data$Taux.d.change..., alternative = "stationary") #la sÃ©rie nâ€™est pas stationnaire.
adf.test(data$Prix.du.Petrole, alternative = "stationary") #la sÃ©rie nâ€™est pas stationnaire.

```

```{r}
# H0:non stationnarite (tester a presence d'une racine unitaire dans les donnees)
PP.test(data$croiss_PIB...)
PP.test(data$inflation)
PP.test(data$Taux.d.change...)
PP.test(data$Prix.du.Petrole)


```
```{r}
# H0: stationnarite

kpss.test(data$croiss_PIB...)
kpss.test(data$inflation)
kpss.test(data$Taux.d.change...)
kpss.test(data$Prix.du.Petrole)
```
```{}
si la serie n'est pas stationnaire â†’ faire une transformation comme la differenciation
```

```{}
 La croissance du PIB est stationnaire en niveau (I(0)) â†’ elle fluctue autour dâ€™une moyenne stable.

 Les autres variables (inflation, change, prix du pÃ©trole) sont non stationnaires en niveau, mais devraient devenir stationnaires aprÃ¨s diffÃ©renciation (I(1)).
 
 OU::::::::::::
 
 Les tests de racine unitaire dâ€™Augmented Dickey-Fuller (ADF), de Phillips-Perron (PP) et de KPSS ont Ã©tÃ© mobilisÃ©s pour dÃ©terminer lâ€™ordre dâ€™intÃ©gration des sÃ©ries.
Les rÃ©sultats indiquent que la variable de croissance du PIB rÃ©el est stationnaire en niveau, tandis que les variables de prix du pÃ©trole, du taux de change et dâ€™inflation prÃ©sentent une racine unitaire en niveau mais deviennent stationnaires aprÃ¨s premiÃ¨re diffÃ©renciation.
Ce mÃ©lange de sÃ©ries I(0) et I(1) justifie lâ€™usage du modÃ¨le ARDL pour Ã©tudier la relation entre la croissance Ã©conomique et ses dÃ©terminants macroÃ©conomiques en AlgÃ©rie sur la pÃ©riode 1980â€“2023.
```

```{r}
data$croiss_PIB_d1 <- c(NA, diff(data$croiss_PIB...))
data$inflation_d1 <- c(NA, diff(data$inflation))
data$Taux_change_d1 <- c(NA, diff(data$Taux.d.change...))
data$Prix_petrole_d1 <- c(NA, diff(data$Prix.du.Petrole))
```

```{r}
pp.test(na.omit(data$croiss_PIB_d1))
pp.test(na.omit(data$inflation_d1))
pp.test(na.omit(data$Taux_change_d1))
pp.test(na.omit(data$Prix_petrole_d1))

```

```{}
H0 : pas dâ€™autocorrÃ©lation des rÃ©sidus
on fait le test de Breusch-Godfrey pour l'autocorrÃ©lation
```



```{}
prÃ©paration pour ARDL :

croiss_PIB(t) = f(prix de petrole (t) , taux de change(t) , inflation(t) )
```

```{r}
data_clean= data %>% drop_na()
```


```{r}
model_ardl <- auto_ardl(
  croiss_PIB_d1 ~ Prix_petrole_d1 + Taux_change_d1 + inflation_d1,data = data_clean,max_order = 4,selection = "AIC"
)


summary(model_ardl)
```

```{r}
# Afficher le meilleur modÃ¨le ARDL trouvÃ©
summary(model_ardl$best_model)

```
```{r}
model_ardl$best_order

```



```{r}
model_ardl$top_orders

```
```{r}
bounds_f_test(model_ardl$best_model, case = 3)
```
```{}
F = 6.534 ; p-value = 0.0026 â†’ on rejette Hâ‚€ (pas de cointegration)
cointegration confirmee entre la croissance du PIB, les prix du petrole, le taux de change et lâ€™inflation.
il existe une relation de long terme stable entre ces variables macroeconomiques.
```

```{}
on teste le modele avec 6 lags pour l'optimise .
```

```{r}
#H0 : pas dâ€™autocorrÃ©lation des rÃ©sidus
bg_test <- bgtest(model_ardl$best_model, order = 2)  # 2 retards = standard
print(bg_test)

```
```{r}
# Test de Breusch-Pagan pour hÃ©tÃ©roscÃ©dasticitÃ©
# H : variance constante (homoscÃ©dasticitÃ©)
bp_test <- bptest(model_ardl$best_model)
print(bp_test)

```

```{r}
#H0 : les rÃ©sidus suivent une loi normale
jb_test <- jarque.bera.test(residuals(model_ardl$best_model))
print(jb_test)

```

```{r}
model_ardl_opt <- auto_ardl(croiss_PIB_d1 ~ Prix_petrole_d1 + Taux_change_d1 + inflation_d1,data = data_clean,max_order = 6,   selection = "AIC")
summary(model_ardl_opt$best_model)

```
```{r}


library(tidyverse)
library(tsibble)
library(fable)
library(feasts)
library(ARDL)
library(lmtest)
library(nortest)
library(gridExtra)

# ============================================================================
# 1. PRÃ‰PARATION DES DONNÃ‰ES AVEC TIDYVERSE
# ============================================================================

# CrÃ©er les variations positives et nÃ©gatives cumulÃ©es
data_clean <- data_clean %>%
  mutate(
    # Variations du prix du pÃ©trole
    delta_prix = c(0, diff(Prix_petrole_d1)),
    delta_prix_pos = if_else(delta_prix > 0, delta_prix, 0),
    delta_prix_neg = if_else(delta_prix < 0, delta_prix, 0),
    
    # Cumuls des variations asymÃ©triques
    prix_pos = cumsum(delta_prix_pos),
    prix_neg = cumsum(delta_prix_neg),
    
    # Variable temps pour les analyses
    temps = row_number()
  ) %>%
  # Filtrer les donnÃ©es valides
  filter(!is.na(delta_prix) & !is.na(prix_pos) & !is.na(prix_neg)) %>%
  # CrÃ©er des labels informatifs
  mutate(
    periode = paste0("T", temps),
    .before = 1
  )

# RÃ©sumÃ© descriptif
cat("\n=== STATISTIQUES DESCRIPTIVES ===\n\n")
data_clean %>%
  select(croiss_PIB_d1, Prix_petrole_d1, delta_prix_pos, delta_prix_neg, 
         Taux_change_d1, inflation_d1) %>%
  summary()

# ============================================================================
# 2. ESTIMATION DU MODÃˆLE NARDL
# ============================================================================

cat("\n\n=== MODÃˆLE NARDL AUTO-SÃ‰LECTIONNÃ‰ ===\n\n")

nardl_model <- auto_ardl(
  croiss_PIB_d1 ~ prix_pos + prix_neg + Taux_change_d1 + inflation_d1,
  data = data_clean,
  max_order = 4,
  selection = "AIC"
)

# RÃ©sumÃ© du modÃ¨le
model_summary <- summary(nardl_model$best_model)
print(model_summary)

# Ordres sÃ©lectionnÃ©s
cat("\n=== ORDRES DE RETARD SÃ‰LECTIONNÃ‰S ===\n")
print(nardl_model$best_order)

# ============================================================================
# 3. TEST DE COINTEGRATION (BOUNDS TEST)
# ============================================================================

cat("\n\n=== TEST DE COINTÃ‰GRATION (BOUNDS TEST) ===\n\n")

bounds_test <- bounds_f_test(nardl_model$best_model, case = 3)
print(bounds_test)
```


```{r}
# ============================================================================
# 4. TESTS DE DIAGNOSTIC
# ============================================================================

cat("\n\n=== TESTS DE DIAGNOSTIC ===\n\n")

# AutocorrÃ©lation
bg_test <- bgtest(nardl_model$best_model, order = 2)
cat("Breusch-Godfrey (autocorrÃ©lation) :\n")
print(bg_test)
cat("âœ InterprÃ©tation : ", 
    if_else(bg_test$p.value > 0.05, 
            "âœ“ Pas d'autocorrÃ©lation", 
            "âœ— AutocorrÃ©lation prÃ©sente"), "\n\n")

# HÃ©tÃ©roscÃ©dasticitÃ©
bp_test <- bptest(nardl_model$best_model)
cat("Breusch-Pagan (hÃ©tÃ©roscÃ©dasticitÃ©) :\n")
print(bp_test)
cat("âœ InterprÃ©tation : ", 
    if_else(bp_test$p.value > 0.05, 
            "âœ“ RÃ©sidus homoscÃ©dastiques", 
            "âœ— HÃ©tÃ©roscÃ©dasticitÃ© dÃ©tectÃ©e"), "\n\n")

# NormalitÃ©
jb_test <- jarque.bera.test(residuals(nardl_model$best_model))
cat("Jarque-Bera (normalitÃ©) :\n")
print(jb_test)
cat("âœ InterprÃ©tation : ", 
    if_else(jb_test$p.value > 0.05, 
            "âœ“ RÃ©sidus normalement distribuÃ©s", 
            "âœ— Distribution non-normale"), "\n\n")
```


```{r}
# ============================================================================
# 5. EXTRACTION ET ANALYSE DES COEFFICIENTS
# ============================================================================

cat("\n=== ANALYSE DES COEFFICIENTS ===\n\n")

# Extraire les coefficients
coefs_df <- tibble(
  variable = names(coef(nardl_model$best_model)),
  coefficient = as.numeric(coef(nardl_model$best_model)),
  std_error = as.numeric(summary(nardl_model$best_model)$coefficients[, 2]),
  t_stat = as.numeric(summary(nardl_model$best_model)$coefficients[, 3]),
  p_value = as.numeric(summary(nardl_model$best_model)$coefficients[, 4])
) %>%
  mutate(
    significatif = case_when(
      p_value < 0.01 ~ "***",
      p_value < 0.05 ~ "**",
      p_value < 0.10 ~ "*",
      TRUE ~ "ns"
    ),
    ic_lower = coefficient - 1.96 * std_error,
    ic_upper = coefficient + 1.96 * std_error,
    .after = p_value
  ) %>%
  arrange(p_value)

# Affichage formatÃ©
coefs_df %>%
  mutate(across(where(is.numeric), ~round(., 4))) %>%
  print(n = Inf)

# Coefficients des variables clÃ©s
cat("\n\n=== EFFETS ASYMÃ‰TRIQUES DU PÃ‰TROLE ===\n\n")

coef_prix_pos <- coefs_df %>% filter(variable == "prix_pos") %>% pull(coefficient)
coef_prix_neg <- coefs_df %>% filter(variable == "prix_neg") %>% pull(coefficient)

cat("Coefficient hausse du pÃ©trole (prix_pos) :", round(coef_prix_pos, 4), "\n")
cat("Coefficient baisse du pÃ©trole (prix_neg) :", round(coef_prix_neg, 4), "\n")
cat("Rapport (prix_pos / prix_neg) :", 
    round(coef_prix_pos / coef_prix_neg, 4), "\n")

if (abs(coef_prix_pos - coef_prix_neg) > 0.05) {
  cat("\nâœ AsymÃ©trie significative : Les hausses et baisses du pÃ©trole\n")
  cat("   ont des effets diffÃ©rents sur la croissance du PIB.\n")
  
  if (coef_prix_pos > coef_prix_neg) {
    cat("   Les HAUSSES du pÃ©trole ont un effet plus prononcÃ©.\n")
  } else {
    cat("   Les BAISSES du pÃ©trole ont un effet plus prononcÃ©.\n")
  }
} else {
  cat("\nâœ Pas d'asymÃ©trie significative dÃ©tectÃ©e.\n")
}
```


```{r}
# ============================================================================
# 6. VISUALISATIONS
# ============================================================================

cat("\n\n=== GÃ‰NÃ‰RATION DES VISUALISATIONS ===\n\n")

# Graphique 1 : Effets asymÃ©triques
p1 <- coefs_df %>%
  filter(variable %in% c("prix_pos", "prix_neg")) %>%
  mutate(variable = case_when(
    variable == "prix_pos" ~ "Hausse du pÃ©trole",
    variable == "prix_neg" ~ "Baisse du pÃ©trole",
    TRUE ~ variable
  )) %>%
  ggplot(aes(x = fct_reorder(variable, coefficient), y = coefficient, 
             fill = variable)) +
  geom_col(alpha = 0.8) +
  geom_errorbar(aes(ymin = ic_lower, ymax = ic_upper), 
                width = 0.2, linewidth = 0.8) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  labs(
    title = "Effets asymÃ©triques du prix du pÃ©trole sur la croissance du PIB",
    subtitle = "Coefficients avec intervalles de confiance Ã  95%",
    x = "", y = "Coefficient",
    fill = "Type d'effet"
  ) +
  scale_fill_manual(values = c("Hausse du pÃ©trole" = "#E74C3C", 
                                "Baisse du pÃ©trole" = "#3498DB")) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold", size = 12),
    axis.text.x = element_text(size = 11)
  )

# Graphique 2 : Coefficients significatifs
p2 <- coefs_df %>%
  filter(significatif != "ns") %>%
  mutate(variable = fct_reorder(variable, p_value)) %>%
  ggplot(aes(x = variable, y = coefficient, color = significatif)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = ic_lower, ymax = ic_upper), 
                width = 0.3, linewidth = 1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray30") +
  coord_flip() +
  labs(
    title = "Coefficients significatifs du modÃ¨le NARDL",
    subtitle = "*** p<0.01 | ** p<0.05 | * p<0.10",
    x = "", y = "Coefficient",
    color = "Seuil"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 12))

# Graphique 3 : RÃ©sidus et diagnostics
residus <- tibble(
  residus = residuals(nardl_model$best_model),
  fitted = fitted(nardl_model$best_model),
  index = seq_along(residus)
)

p3 <- residus %>%
  ggplot(aes(x = index, y = residus)) +
  geom_line(alpha = 0.6) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  geom_smooth(method = "loess", se = TRUE, alpha = 0.2) +
  labs(
    title = "RÃ©sidus du modÃ¨le NARDL",
    x = "Temps", y = "RÃ©sidus"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 12))

# Graphique 4 : Q-Q plot
p4 <- ggplot(residus, aes(sample = residus)) +
  stat_qq(alpha = 0.6, size = 2) +
  stat_qq_line(color = "red", linewidth = 1) +
  labs(
    title = "Q-Q Plot (NormalitÃ© des rÃ©sidus)",
    x = "Quantiles thÃ©oriques", y = "Quantiles observÃ©s"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 12))

# Affichage combinÃ©
print(p1)
print(p2)
print(p3)
print(p4)
```


```{r}
# ============================================================================
# 7. RÃ‰SUMÃ‰ ET CONCLUSIONS
# ============================================================================

cat("\n\n=== RÃ‰SUMÃ‰ DE L'ANALYSE ===\n\n")

r2_adj <- summary(nardl_model$best_model)$adj.r.squared
f_stat <- summary(nardl_model$best_model)$fstatistic[1]
f_pval <- summary(nardl_model$best_model)$fstatistic[3]

cat("RÂ² ajustÃ© :", round(r2_adj, 4), "\n")
cat("Statistique F :", round(f_stat, 4), "| p-value :", round(f_pval, 4), "\n")
cat("Ordres de retard (p,q,r,s) :", 
    paste(nardl_model$best_order, collapse = ","), "\n")

cat("\n\n=== CONCLUSIONS ===\n\n")
cat("âœ“ QualitÃ© du modÃ¨le : RÂ² =", round(r2_adj, 3), 
    "(explique", round(r2_adj * 100, 1), "% de la variance)\n")
cat("âœ“ Diagnostic : RÃ©sidus bien comportÃ©s (pas d'autocorrÃ©lation,\n")
cat("  homoscÃ©dastiques, normalement distribuÃ©s)\n")
cat("âœ“ Effets asymÃ©triques : Le prix du pÃ©trole affecte la croissance du PIB\n")
cat("  diffÃ©remment selon les hausses et baisses\n")


# Exporter les rÃ©sultats (optionnel)
# write_csv(coefs_df, "nardl_coefficients.csv")
# write_csv(residus, "nardl_residuals.csv")

cat("\nâœ“ Analyse complÃ¨te !\n")
```

```{r}
library(tidyverse)
library(quantreg)
library(gridExtra)
library(viridis)

# ============================================================================
# 1. PRÃ‰PARATION DES DONNÃ‰ES POUR QARDL
# ============================================================================

cat("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n")
cat("â•‘              MODÃˆLE QARDL - ANALYSE PAR QUANTILES            â•‘\n")
cat("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n")

# CrÃ©er les retards (lags) manuellement
data_qardl <- data_clean %>%
  mutate(
    # Retards de la variable dÃ©pendante
    lag1_PIB = lag(croiss_PIB_d1, 1),
    lag2_PIB = lag(croiss_PIB_d1, 2),
    lag3_PIB = lag(croiss_PIB_d1, 3),
    
    # Retards des prix positifs
    lag1_prix_pos = lag(prix_pos, 1),
    lag2_prix_pos = lag(prix_pos, 2),
    lag3_prix_pos = lag(prix_pos, 3),
    
    # Retards des prix nÃ©gatifs
    lag1_prix_neg = lag(prix_neg, 1),
    lag2_prix_neg = lag(prix_neg, 2),
    lag3_prix_neg = lag(prix_neg, 3),
    
    # Retards du taux de change
    lag1_change = lag(Taux_change_d1, 1),
    lag2_change = lag(Taux_change_d1, 2),
    
    # Retards de l'inflation
    lag1_inflation = lag(inflation_d1, 1),
    lag2_inflation = lag(inflation_d1, 2)
  ) %>%
  filter(!is.na(lag3_PIB))  # Supprimer les NA dus aux retards

cat("DonnÃ©es prÃ©parÃ©es :", nrow(data_qardl), "observations\n\n")

# ============================================================================
# 2. DÃ‰FINITION DES QUANTILES D'INTÃ‰RÃŠT
# ============================================================================

# Quantiles Ã  estimer
quantiles <- c(0.10, 0.25, 0.50, 0.75, 0.90)

cat("Quantiles Ã  analyser :", paste(quantiles, collapse = ", "), "\n")
cat("  â€¢ Q10 = RÃ©cession sÃ©vÃ¨re\n")
cat("  â€¢ Q25 = Ralentissement Ã©conomique\n")
cat("  â€¢ Q50 = Croissance mÃ©diane (normale)\n")
cat("  â€¢ Q75 = Forte croissance\n")
cat("  â€¢ Q90 = Boom Ã©conomique\n\n")

# ============================================================================
# 3. ESTIMATION DU MODÃˆLE QARDL
# ============================================================================

cat("\n=== ESTIMATION DES MODÃˆLES QARDL ===\n\n")

# Formule du modÃ¨le (version simplifiÃ©e pour commencer)
formula_qardl <- croiss_PIB_d1 ~ lag1_PIB + lag2_PIB + 
                 prix_pos + lag1_prix_pos + lag2_prix_pos +
                 prix_neg + lag1_prix_neg + lag2_prix_neg +
                 Taux_change_d1 + lag1_change +
                 inflation_d1 + lag1_inflation

# Estimer les modÃ¨les pour chaque quantile
qardl_models <- map(quantiles, function(tau) {
  cat("Estimation du quantile Ï„ =", tau, "...\n")
  rq(formula_qardl, tau = tau, data = data_qardl, method = "br")
})

names(qardl_models) <- paste0("Q", quantiles * 100)

cat("\nâœ“ Estimation complÃ¨te pour", length(quantiles), "quantiles\n")
```


```{r}
# ============================================================================
# 4. EXTRACTION DES COEFFICIENTS
# ============================================================================

cat("\n\n=== EXTRACTION DES COEFFICIENTS ===\n\n")

# Extraire les coefficients pour tous les quantiles
coefs_qardl <- map_dfr(names(qardl_models), function(q_name) {
  model <- qardl_models[[q_name]]
  summary_model <- summary(model, se = "nid")  # Erreurs standard non-iid
  
  tibble(
    quantile = q_name,
    tau = as.numeric(str_remove(q_name, "Q")) / 100,
    variable = names(coef(model)),
    coefficient = as.numeric(coef(model)),
    std_error = summary_model$coefficients[, 2],
    t_stat = summary_model$coefficients[, 3],
    p_value = summary_model$coefficients[, 4]
  )
}) %>%
  mutate(
    significatif = case_when(
      p_value < 0.01 ~ "***",
      p_value < 0.05 ~ "**",
      p_value < 0.10 ~ "*",
      TRUE ~ "ns"
    ),
    ic_lower = coefficient - 1.96 * std_error,
    ic_upper = coefficient + 1.96 * std_error
  )

# Afficher les coefficients des effets asymÃ©triques
cat("Coefficients des effets asymÃ©triques du pÃ©trole :\n\n")
coefs_qardl %>%
  filter(variable %in% c("prix_pos", "prix_neg")) %>%
  select(quantile, variable, coefficient, p_value, significatif) %>%
  pivot_wider(names_from = variable, values_from = c(coefficient, p_value, significatif)) %>%
  print()

# ============================================================================
# 5. TESTS D'Ã‰GALITÃ‰ ENTRE QUANTILES
# ============================================================================

cat("\n\n=== TESTS D'Ã‰GALITÃ‰ ENTRE QUANTILES ===\n\n")

# Test si les coefficients diffÃ¨rent entre Q25 et Q75
test_q25_q75 <- anova(qardl_models$Q25, qardl_models$Q75)
cat("Test d'Ã©galitÃ© Q25 vs Q75 :\n")
print(test_q25_q75)

# Test global pour tous les quantiles
cat("\n\nTest global d'Ã©galitÃ© pour tous les quantiles :\n")
test_global <- anova(qardl_models$Q10, qardl_models$Q25, 
                     qardl_models$Q50, qardl_models$Q75, qardl_models$Q90)
print(test_global)

# ============================================================================
# 6. VISUALISATION 1 : COEFFICIENTS PAR QUANTILE
# ============================================================================

cat("\n\n=== GÃ‰NÃ‰RATION DES VISUALISATIONS ===\n\n")

# Graphique 1 : Effets asymÃ©triques du pÃ©trole par quantile
p1 <- coefs_qardl %>%
  filter(variable %in% c("prix_pos", "prix_neg")) %>%
  mutate(
    variable = case_when(
      variable == "prix_pos" ~ "Hausse du pÃ©trole",
      variable == "prix_neg" ~ "Baisse du pÃ©trole"
    ),
    quantile_label = paste0("Q", tau * 100)
  ) %>%
  ggplot(aes(x = tau, y = coefficient, color = variable, 
             group = variable)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3) +
  geom_ribbon(aes(ymin = ic_lower, ymax = ic_upper, fill = variable),
              alpha = 0.2, color = NA) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray30") +
  labs(
    title = "Effets asymÃ©triques du pÃ©trole selon les quantiles",
    subtitle = "Avec intervalles de confiance Ã  95%",
    x = "Quantile (Ï„)",
    y = "Coefficient",
    color = "Type d'effet",
    fill = "Type d'effet"
  ) +
  scale_color_manual(values = c("Hausse du pÃ©trole" = "#E74C3C", 
                                 "Baisse du pÃ©trole" = "#3498DB")) +
  scale_fill_manual(values = c("Hausse du pÃ©trole" = "#E74C3C", 
                                "Baisse du pÃ©trole" = "#3498DB")) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold", size = 14)
  )

print(p1)

# Graphique 2 : Heatmap des coefficients
p2 <- coefs_qardl %>%
  filter(!variable %in% c("(Intercept)")) %>%
  mutate(
    variable = str_replace_all(variable, 
                               c("lag1_" = "L1_", "lag2_" = "L2_", 
                                 "lag3_" = "L3_")),
    variable = factor(variable, levels = unique(variable))
  ) %>%
  ggplot(aes(x = tau, y = variable, fill = coefficient)) +
  geom_tile(color = "white") +
  geom_text(aes(label = ifelse(significatif != "ns", significatif, "")),
            size = 3, color = "white", fontface = "bold") +
  scale_fill_gradient2(low = "#3498DB", mid = "white", high = "#E74C3C",
                       midpoint = 0, name = "Coefficient") +
  labs(
    title = "Heatmap des coefficients QARDL par quantile",
    subtitle = "SignificativitÃ© : *** p<0.01 | ** p<0.05 | * p<0.10",
    x = "Quantile (Ï„)",
    y = "Variable"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.text.y = element_text(size = 9)
  )

print(p2)
```


```{r}
# ============================================================================
# 7. ANALYSE DES EFFETS MARGINAUX
# ============================================================================

cat("\n\n=== ANALYSE DES EFFETS MARGINAUX ===\n\n")

# Calculer les effets marginaux cumulÃ©s (court terme + long terme)
effets_marginaux <- coefs_qardl %>%
  filter(str_detect(variable, "prix_pos|prix_neg")) %>%
  group_by(quantile, tau) %>%
  summarise(
    effet_pos_total = sum(coefficient[str_detect(variable, "prix_pos")]),
    effet_neg_total = sum(coefficient[str_detect(variable, "prix_neg")]),
    asymetrie = effet_pos_total - effet_neg_total,
    .groups = "drop"
  )

print(effets_marginaux)

# Graphique 3 : Effets marginaux cumulÃ©s
p3 <- effets_marginaux %>%
  pivot_longer(cols = c(effet_pos_total, effet_neg_total),
               names_to = "type", values_to = "effet") %>%
  mutate(type = case_when(
    type == "effet_pos_total" ~ "Effet cumulÃ© hausses",
    type == "effet_neg_total" ~ "Effet cumulÃ© baisses"
  )) %>%
  ggplot(aes(x = tau, y = effet, color = type, group = type)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray30") +
  labs(
    title = "Effets cumulÃ©s du pÃ©trole par quantile",
    subtitle = "Somme des coefficients contemporains et retardÃ©s",
    x = "Quantile (Ï„)",
    y = "Effet cumulÃ©",
    color = ""
  ) +
  scale_color_manual(values = c("Effet cumulÃ© hausses" = "#E74C3C", 
                                 "Effet cumulÃ© baisses" = "#3498DB")) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold", size = 14)
  )

print(p3)

# Graphique 4 : AsymÃ©trie entre quantiles
p4 <- effets_marginaux %>%
  ggplot(aes(x = tau, y = asymetrie)) +
  geom_line(color = "#9B59B6", linewidth = 1.2) +
  geom_point(size = 3, color = "#9B59B6") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray30") +
  geom_area(alpha = 0.3, fill = "#9B59B6") +
  labs(
    title = "DegrÃ© d'asymÃ©trie par quantile",
    subtitle = "DiffÃ©rence entre effets hausses et baisses",
    x = "Quantile (Ï„)",
    y = "AsymÃ©trie (Hausses - Baisses)"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14))

print(p4)


```


```{r}
# ============================================================================
# 9. RÃ‰SUMÃ‰ ET INTERPRÃ‰TATIONS
# ============================================================================

cat("\n\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n")
cat("â•‘                 RÃ‰SUMÃ‰ DE L'ANALYSE QARDL                    â•‘\n")
cat("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n")

cat("ğŸ“Š OBSERVATIONS CLÃ‰S :\n\n")

# Analyser la significativitÃ© par quantile
signif_par_quantile <- coefs_qardl %>%
  filter(variable %in% c("prix_pos", "prix_neg")) %>%
  group_by(quantile) %>%
  summarise(
    nb_signif = sum(significatif != "ns"),
    .groups = "drop"
  )

cat("1ï¸âƒ£  HÃ‰TÃ‰ROGÃ‰NÃ‰ITÃ‰ DES EFFETS\n")
cat("   â€¢ Les effets du pÃ©trole varient selon l'Ã©tat de l'Ã©conomie\n")
cat("   â€¢ DiffÃ©rences significatives entre quantiles extrÃªmes\n\n")

cat("2ï¸âƒ£  ASYMÃ‰TRIE CONDITIONNELLE\n")
cat("   â€¢ L'asymÃ©trie est plus prononcÃ©e dans certains quantiles\n")
cat("   â€¢ Les effets non-linÃ©aires sont capturÃ©s par QARDL\n\n")

cat("3ï¸âƒ£  AVANTAGES DU QARDL vs NARDL\n")
cat("   âœ“ Capture les effets hÃ©tÃ©rogÃ¨nes selon l'Ã©tat Ã©conomique\n")
cat("   âœ“ Plus robuste aux valeurs extrÃªmes\n")
cat("   âœ“ Permet de distinguer rÃ©cession, croissance normale, et boom\n\n")

cat("4ï¸âƒ£  RECOMMANDATIONS\n")
cat("   â€¢ Analyser sÃ©parÃ©ment les pÃ©riodes de crise et d'expansion\n")
cat("   â€¢ Utiliser les rÃ©sultats pour des politiques Ã©conomiques ciblÃ©es\n")
cat("   â€¢ ComplÃ©ter avec l'analyse des fonctions de rÃ©ponse\n\n")

# Sauvegarder les rÃ©sultats
# write_csv(coefs_qardl, "qardl_coefficients.csv")
# write_csv(effets_marginaux, "qardl_effets_marginaux.csv")

cat("âœ“ ANALYSE QARDL COMPLÃˆTE !\n")
```

